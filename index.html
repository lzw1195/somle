<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>热图和标记</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJhMG_t2IcSck60ta18BPFRxiTOmXHaeU&libraries=visualization"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .controls {
            margin-bottom: 20px;
        }

        label {
            margin-right: 10px;
        }

        select, input, button {
            padding: 10px;
            margin-right: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        #map {
            height: 1000px;
            width: 100%;
        }

        #password-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }

        #password-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        #password-input {
            padding: 10px;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="password-prompt">
    <div id="password-container">
        <h2>请输入密码</h2>
        <input type="password" id="password-input" placeholder="密码">
        <button onclick="checkPassword()">提交</button>
        <p id="error-message" style="color:red; display:none;">密码错误，请重试。</p>
    </div>
</div>

<div class="controls" style="display: none;">
    <label for="year-select">选择年份:</label>
    <select id="year-select">
        <option value="2024">2024</option>
    </select>

    <label for="platform-select">选择平台:</label>
    <select id="platform-select">
        <option value="all">所有平台</option>
    </select>

    <label for="sku-select">选择SKU:</label>
    <input list="sku-options" id="sku-select" placeholder="所有SKU">
    <datalist id="sku-options">
        <option value="all">所有SKU</option>
    </datalist>

    <button id="load-data">加载数据</button>
</div>

<div id="map" style="display: none;"></div>

<div class="controls" style="display: none;">
    <button id="toggle-heatmap">切换热图</button>
    <button id="change-gradient">改变渐变</button>
    <button id="change-opacity">改变不透明度</button>
    <button id="change-radius">改变半径</button>
    <button id="toggle-markers">切换标记</button>
</div>

<script>
    const correctPassword = 'somle';

    function checkPassword() {
        const inputPassword = document.getElementById('password-input').value;
        if (inputPassword === correctPassword) {
            document.getElementById('password-prompt').style.display = 'none';
            document.querySelectorAll('.controls').forEach(el => el.style.display = 'block');
            document.getElementById('map').style.display = 'block';
            loadData(); // 自动加载数据
        } else {
            document.getElementById('error-message').style.display = 'block';
        }
    }

    let map, heatmap, markers = [];
    let markersVisible = true;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 13,
            center: { lat: 38.469044, lng: -90.7623135 },
            mapTypeId: "satellite",
        });

        document.getElementById("load-data").addEventListener("click", loadData);

        document.getElementById("toggle-heatmap").addEventListener("click", toggleHeatmap);
        document.getElementById("change-gradient").addEventListener("click", changeGradient);
        document.getElementById("change-opacity").addEventListener("click", changeOpacity);
        document.getElementById("change-radius").addEventListener("click", changeRadius);
        document.getElementById("toggle-markers").addEventListener("click", toggleMarkers);
    }

    async function loadData() {
        const year = document.getElementById("year-select").value;
        const selectedPlatform = document.getElementById("platform-select").value;
        const selectedSku = document.getElementById("sku-select").value;
        const csvFilePath = `https://somle-huaweiyun.obs.ap-southeast-1.myhuaweicloud.com/geo2024_7_22.csv.gz`;

        try {
            const response = await fetch(csvFilePath);
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const decompressed = pako.ungzip(data, { to: 'string' });
            updatePlatformAndSkuOptions(decompressed);
            getPoints(decompressed, selectedPlatform, selectedSku, function(points, markerDataArray) {
                if (heatmap) {
                    heatmap.setMap(null);
                }

                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: points,
                    map: map,
                });

                markers.forEach(marker => marker.setMap(null)); // Remove existing markers
                markers = []; // Clear the markers array

                markerDataArray.forEach(markerData => {
                    const marker = new google.maps.Marker({
                        position: markerData.position,
                        map: map,
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: markerData.info,
                    });

                    marker.addListener('mouseover', () => {
                        infoWindow.open(map, marker);
                    });

                    marker.addListener('mouseout', () => {
                        infoWindow.close();
                    });

                    markers.push(marker); // Store the new marker
                });
            });

            // Reset platform and sku options to the previously selected values
            document.getElementById("platform-select").value = selectedPlatform;
            document.getElementById("sku-select").value = selectedSku;
        } catch (error) {
            console.error('Error fetching or decompressing CSV file:', error);
        }
    }

    function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
    }

    function changeGradient() {
        const gradient = [
            "rgba(0, 255, 255, 0)",
            "rgba(0, 255, 255, 1)",
            "rgba(0, 191, 255, 1)",
            "rgba(0, 127, 255, 1)",
            "rgba(0, 63, 255, 1)",
            "rgba(0, 0, 255, 1)",
            "rgba(0, 0, 223, 1)",
            "rgba(0, 0, 191, 1)",
            "rgba(0, 0,159, 1)",
            "rgba(0, 0, 127, 1)",
            "rgba(63, 0, 91, 1)",
            "rgba(127, 0, 63, 1)",
            "rgba(191, 0, 31, 1)",
            "rgba(255, 0, 0, 1)",
        ];

        heatmap.set("gradient", heatmap.get("gradient") ? null : gradient);
    }

    function changeRadius() {
        heatmap.set("radius", heatmap.get("radius") ? null : 20);
    }

    function changeOpacity() {
        heatmap.set("opacity", heatmap.get("opacity") ? null : 0.2);
    }

    function toggleMarkers() {
        markersVisible = !markersVisible;
        markers.forEach(marker => {
            marker.setMap(markersVisible ? map : null);
        });
    }

    function updatePlatformAndSkuOptions(csvText) {
        const platforms = new Set();
        const skus = new Set();
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                results.data.forEach(row => {
                    if (row.platform) {
                        platforms.add(row.platform);
                    }
                    if (row.sku) {
                        skus.add(row.sku);
                    }
                });

                // 将平台和 SKU 集合转换为数组并排序
                const sortedPlatforms = Array.from(platforms).sort();
                const sortedSkus = Array.from(skus).sort();

                const platformSelect = document.getElementById("platform-select");
                platformSelect.innerHTML = '<option value="all">所有平台</option>';

                sortedPlatforms.forEach(platform => {
                    const option = document.createElement("option");
                    option.value = platform;
                    option.textContent = platform;
                    platformSelect.appendChild(option);
                });

                const skuSelect = document.getElementById("sku-select");
                const datalist = document.getElementById("sku-options");
                datalist.innerHTML = '';

                const allOption = document.createElement("option");
                allOption.value = 'all';
                allOption.textContent = '所有SKU';
                datalist.appendChild(allOption);

                sortedSkus.forEach(sku => {
                    const option = document.createElement("option");
                    option.value = sku;
                    option.textContent = sku;
                    datalist.appendChild(option);
                });
            }
        });
    }

    function getPoints(csvText, selectedPlatform, selectedSku, callback) {
        const points = [];
        const markerDataArray = [];
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                results.data.forEach(row => {
                    if (row.latitude && row.longitude && row.platform && row.sku) {
                        if ((selectedPlatform === 'all' || row.platform === selectedPlatform) &&
                            (selectedSku === 'all' || row.sku === selectedSku)) {
                            const position = new google.maps.LatLng(row.latitude, row.longitude);
                            points.push(position);
                            const streetViewUrl = `https://maps.googleapis.com/maps/api/streetview?size=400x400&location=${row.latitude},${row.longitude}&fov=80&heading=70&pitch=0&key=AIzaSyCCMzvLrAgAEaj76qTEte1GnAou-JPw8i4`;
                            const infoContent = `买家名称: ${row.buyer_name}<br>
                                                国家名称: ${row.country_name}<br>
                                                城市名称: ${row.city_name}<br>
                                                平台: ${row.platform}<br>
                                                SKU: ${row.sku}<br>
                                                纬度: ${row.latitude}<br>
                                                经度: ${row.longitude}<br>
                                                <img src="${streetViewUrl}" alt="Street View Image">`;
                            markerDataArray.push({
                                position: position,
                                info: infoContent
                            });
                        }
                    }
                });
                callback(points, markerDataArray);
            }
        });
    }

    function loadScript() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyAJhMG_t2IcSck60ta18BPFRxiTOmXHaeU&libraries=visualization&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }

    document.addEventListener("DOMContentLoaded", loadScript);
</script>
</body>
</html>
